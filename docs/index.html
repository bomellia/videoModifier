<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Video Trimmer</title>
</head>
<body>

<input type="file" id="fileInput" accept="video/*">
<video id="video" controls style="max-width:100%"></video>
<br>
開始 <input type="range" id="start" step="0.1" value="0">
終了 <input type="range" id="end" step="0.1" value="0">
<br>
<button id="trim">トリミング</button>
<p id="status"></p>
<a id="download" style="display:none"></a>

<script type="module">
import { FFmpeg } from "https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.15/+esm";
import { fetchFile, toBlobURL } from "https://cdn.jsdelivr.net/npm/@ffmpeg/util@0.12.2/+esm";

const ffmpeg = new FFmpeg({ log: true });

const fileInput = document.getElementById("fileInput");
const video = document.getElementById("video");
const start = document.getElementById("start");
const end = document.getElementById("end");
const trimBtn = document.getElementById("trim");
const status = document.getElementById("status");
const download = document.getElementById("download");

let file;

fileInput.onchange = (e) => {
  file = e.target.files[0];
  video.src = URL.createObjectURL(file);

  video.onloadedmetadata = () => {
    start.max = video.duration;
    end.max = video.duration;
    end.value = video.duration;
  };
};

trimBtn.onclick = async () => {
  status.textContent = "ロード中...";

  await ffmpeg.load({
    coreURL: await toBlobURL(
      "https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.6/dist/esm/ffmpeg-core.js",
      "text/javascript"
    ),
    wasmURL: await toBlobURL(
      "https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.6/dist/esm/ffmpeg-core.wasm",
      "application/wasm"
    )
  });

  status.textContent = "処理中...";

  await ffmpeg.writeFile("input.mp4", await fetchFile(file));

  await ffmpeg.exec([
    "-ss", start.value,
    "-to", end.value,
    "-i", "input.mp4",
    "-c", "copy",
    "out.mp4"
  ]);

  const data = await ffmpeg.readFile("out.mp4");
  const blob = new Blob([data.buffer], { type: "video/mp4" });

  download.href = URL.createObjectURL(blob);
  download.download = "trimmed.mp4";
  download.textContent = "ダウンロード";
  download.style.display = "block";

  status.textContent = "完了";
};
</script>

</body>
</html>
